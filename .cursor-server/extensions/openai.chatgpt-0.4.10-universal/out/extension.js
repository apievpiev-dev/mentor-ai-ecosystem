"use strict";var To=Object.create;var ce=Object.defineProperty;var Ao=Object.getOwnPropertyDescriptor;var Io=Object.getOwnPropertyNames;var Mo=Object.getPrototypeOf,Do=Object.prototype.hasOwnProperty;var R=(n,e)=>()=>(n&&(e=n(n=0)),e);var ze=(n,e)=>{for(var t in e)ce(n,t,{get:e[t],enumerable:!0})},Je=(n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Io(e))!Do.call(n,s)&&s!==t&&ce(n,s,{get:()=>e[s],enumerable:!(o=Ao(e,s))||o.enumerable});return n};var v=(n,e,t)=>(t=n!=null?To(Mo(n)):{},Je(e||!n||!n.__esModule?ce(t,"default",{value:n,enumerable:!0}):t,n)),Oo=n=>Je(ce({},"__esModule",{value:!0}),n);var pe=R(()=>{"use strict"});function k(){return Xe.workspace.getConfiguration("chatgpt")}var Xe,Qe,Ye,K=R(()=>{"use strict";Xe=v(require("vscode")),Qe="apiEndpoint",Ye="logLevel"});function de(n){return Ze[n]<=Ze[_o]}function Lo(){let n=et.window.createOutputChannel("Codex",{log:!0});return{trace:(t,...o)=>{de("trace")&&n.trace(t,...o)},debug:(t,...o)=>{de("debug")&&n.debug(t,...o)},info:(t,...o)=>{de("info")&&n.info(t,...o)},error:(t,...o)=>{n.error(t,...o)},warn:(t,...o)=>{de("warning")&&n.warn(t,...o)},dispose:()=>n.dispose()}}var et,No,_o,Ze,p,P=R(()=>{"use strict";K();pe();et=v(require("vscode")),No="warning",_o=k().get(Ye)??No,Ze={error:0,warning:1,info:2,debug:3,trace:4};p=Lo()});function kt(n){return Object.prototype.hasOwnProperty.call(Ee,n)?n:null}var St,X,Ee,Et,Tt,At,ne,It,Mt,Dt,Ot,Nt,V=R(()=>{"use strict";St=require("crypto"),X=v(require("vscode")),Ee={content:{category:"queryGet",version:1},ping:{category:"queryGet",version:1},selections:{category:"queryGet",version:1},reload:{category:"queryGet",version:1},markForReload:{category:"queryPost",version:1},removeHighlights:{category:"mutationPost",version:1},highlightLines:{category:"mutationPost",version:1},highlight:{category:"mutationPost",version:1},setContent:{category:"mutationPost",version:1},replaceSelection:{category:"mutationPost",version:1}},Et=Object.fromEntries(Object.entries(Ee).map(([n,e])=>[n,e.version]));Tt=`oai_pwai ${X.env.appName}`,At=X.workspace.name??X.env.appName,ne=X.env.appName+"-"+(0,St.randomUUID)(),It="com.microsoft.VSCode",Mt="com.microsoft.VSCodeInsiders",Dt="com.vscodium",Ot="com.todesktop.230313mzl4w4u92",Nt="com.exafunction.windsurf"});function L(n){return Ge().find(o=>o.document.fileName===n)||null}function Lt(){return Ge().map((e,t)=>{let o=e.selection.isEmpty?null:e.document.getText(e.selection),s=e.selection.isEmpty?null:e.selection.start.line;return o!=null&&s!=null?{selectedText:o,selectionLine:s}:null}).filter(e=>!!e)}function Ft(){return Ge().map((e,t)=>{let o=e.document.getText(),s=e.document.fileName,r=e.selection.isEmpty?null:e.document.getText(e.selection),a=e.document.offsetAt(e.selection.start),i=e.document.offsetAt(e.selection.end),c=e.selection.isEmpty?null:e.selection.start.line,u=e.selection.isEmpty?null:{location:a,length:i-a};return r===o&&(r=null),{id:s,content:o,filename:s,selectedText:r,selectionRange:u,selectionLine:c}}).filter(e=>!!e)}function Ge(){return _t.window.visibleTextEditors.filter(e=>e.viewColumn!==void 0)}var _t,ke=R(()=>{"use strict";_t=v(require("vscode"))});function F(n){throw new Error(`No editor for id ${n} found`)}var He=R(()=>{"use strict"});async function Ut(n,e){let t=L(e);t||F(e);let o=t.document,s=new Q.Range(o.positionAt(0),o.positionAt(o.getText().length));await t.edit(a=>{a.replace(s,n)});let r=t.document.positionAt(n.length);t.selection=new Q.Selection(r,r)}async function qt(n,e){let t=L(e);t||F(e);let o=t.selection,s=new Q.Range(o.start,o.end);await t.edit(r=>{r.replace(s,n)}),t.selection=new Q.Selection(s.start,s.start)}var Q,$t=R(()=>{"use strict";ke();He();Q=v(require("vscode"))});async function Ht(n,e){let t=L(e);t||F(e);let o=n.map(s=>{let r=new T.Range(s,0,s,t.document.lineAt(s).range.end.character);return Vt(r,e)});await Promise.all(o)}function cn(n){return new Promise(e=>setTimeout(e,n))}async function Vt(n,e){let t=L(e);t||F(e),t.revealRange(n,T.TextEditorRevealType.InCenterIfOutsideViewport);let o=T.window.createTextEditorDecorationType({backgroundColor:`rgba(255, 255, 0, ${Gt})`,isWholeLine:!0});t.setDecorations(o,[n]);let s=T.workspace.onDidChangeTextDocument(r=>{r.document===t.document&&(o.dispose(),B[e]=[],s.dispose())});B[e]||(B[e]=[]),B[e].push({range:n,decoration:o})}async function Bt(n,e){let t=L(n);t||F(n),se[n]||(se[n]=1);let o=++se[n];if(e){let a=(B[n]||[]).map(async i=>{let c=i.decoration,u=10,h=500/u;try{for(let d=0;d<=u&&o===se[n];d++){let f=d/u,g=Gt*(1-f),S=T.window.createTextEditorDecorationType({backgroundColor:`rgba(255, 255, 0, ${g})`,isWholeLine:!0});t.setDecorations(S,[i.range]),c?.dispose(),c=S,await cn(h)}}finally{c?.dispose()}});await Promise.all(a)}let s=B[n];s&&o===se[n]&&(s.forEach(r=>r.decoration.dispose()),delete B[n])}async function Wt(n,e,t){let o=L(t);o||F(t);let s=pn(n,e,o.document);s&&await Vt(s,t)}function pn(n,e,t){let o=0,s=0,r=0,a=0,i=0;for(let c=0;c<t.lineCount;c++){let m=t.lineAt(c).text.length+1;if(o<=n&&o+m>n&&(s=c,a=n-o),o<=e&&o+m>e){r=c,i=e-o;break}o+=m}if(s>=0&&r>=0){let c=new T.Position(s,a),u=new T.Position(r,i);return new T.Range(c,u)}return null}var T,B,se,Gt,jt=R(()=>{"use strict";ke();He();T=v(require("vscode")),B={},se={},Gt=.2});async function Jt(n,e){switch(n){case"removeHighlights":try{let{textfieldID:t,animated:o}=e;return await Bt(t,o),{status:"success",message:"Removed highlight"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"highlightLines":try{let{lines:t,textfieldID:o}=e;return await Ht(t,o),{status:"success",message:"Text highlighted successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"highlight":try{let{startChar:t,endChar:o,textfieldID:s}=e;return await Wt(t,o,s),{status:"success",message:"Text highlighted successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"setContent":try{let{content:t,textfieldID:o}=e;return await Ut(t,o),{status:"success",message:"Set content successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"replaceSelection":try{let{content:t,textfieldID:o}=e;return await qt(t,o),{status:"success",message:"Replaced selection successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}}}var Xt=R(()=>{"use strict";V();$t();jt()});async function Qt(n,e){let t=Buffer.alloc(0),o=null;n.on("data",async s=>{if(t=Buffer.concat([t,s]),o==null&&t.length>=4&&(o=t.readUInt32LE(0),t=t.subarray(4)),o!=null&&t.length>=o){let r=t.subarray(0,o).toString();t=t.subarray(o),o=null,await e(n,r)}}),n.on("end",()=>{p.debug("Desktop bridge: client disconnected")}),n.on("error",s=>{p.error("Desktop bridge socket error:",s)})}function re(n,e){let t=JSON.stringify(e),o=Buffer.alloc(4),s=Buffer.byteLength(t);o.writeUInt32LE(s,0);let r=Buffer.from(t,"utf-8");n.write(o),n.write(r),n.end()}var Ve=R(()=>{"use strict";P()});function Be(){return Ae.join(Zt.homedir(),"Library","Application Support","com.openai.chat","app_pairing_extensions",ne)}function ln(n){let e=Be();if(x.existsSync(e)){let t=x.watch(e,o=>{x.existsSync(e)||(n(),t.close())})}else p.warn("Desktop bridge: session path does not exist, cannot watch file.")}var x,Yt,Zt,Ae,Te,eo=R(()=>{"use strict";P();V();Ve();x=v(require("fs")),Yt=v(require("net")),Zt=v(require("os")),Ae=v(require("path"));Te=class{getSessionSocketPath(){return`/tmp/${ne}.sock`}async deregister(){let e=Be();p.info("Desktop bridge deregister",e),x.existsSync(e)&&x.unlinkSync(e),x.existsSync(this.getSessionSocketPath())&&x.unlinkSync(this.getSessionSocketPath())}async register(e,t){let o=Be(),s=Ae.dirname(o);x.existsSync(s)||x.mkdirSync(s,{recursive:!0}),x.writeFileSync(o,JSON.stringify(e),"utf8"),p.info(`Desktop bridge wrote payload to ${o}`);let r=this.getSessionSocketPath();x.existsSync(r)?x.chmodSync(r,384):p.warn("Desktop bridge: socket file does not exist"),ln(t)}startServer(e,t){let o=this.getSessionSocketPath();x.existsSync(o)&&x.unlinkSync(o);let s=Yt.createServer(r=>{p.debug("Desktop bridge: client connected"),Qt(r,t)});s.listen(o,()=>{p.info(`Desktop bridge listening on UNIX socket: ${o}`)}),e.subscriptions.push({dispose:()=>{s.close(),this.deregister()}})}}});function un(){if(to.platform()!=="darwin")throw new Error("Unsupported platform");return new Te}var to,W,We=R(()=>{"use strict";eo();to=v(require("os"));W=un()});function no(){switch(oo.env.appName){case"Visual Studio Code":return It;case"Visual Studio Code - Insiders":return Mt;case"VSCodium":return Dt;case"Cursor":return Ot;case"Windsurf":return Nt;default:return null}}var oo,so=R(()=>{"use strict";V();oo=v(require("vscode"))});var mn,ie,je=R(()=>{"use strict";mn="0.0.1731016154",ie={name:"openai.chatgpt",version:mn,isInstalled:!0}});function io(n){ro=n,W.deregister(),Ie()}function Ie(){let n=no();if(!n)return;let e=W.getSessionSocketPath(),t={appName:U.env.appName,bundleID:n,extensionVersion:ie.version,marketplaceID:ie.name,extensionName:Tt,workspaceName:At,id:ne,capabilities:Et,needsReload:ro,socketPath:e,timestamp:Date.now()};W.register(t,()=>{let o=U.l10n.t("Reregister"),s=U.l10n.t("Dismiss");U.window.showWarningMessage(U.l10n.t("The ChatGPT extension cannot find its registration file"),o,s).then(r=>{r===o&&Ie()})})}var U,ro,Ke=R(()=>{"use strict";so();V();We();je();U=v(require("vscode")),ro=!1});function co(n){switch(n){case"ping":{let{name:e,version:t}=ie;return{status:"success",version:t,name:e}}case"content":{let e=Ft();return e!=null?{status:"success",textfields:e}:{status:400,error:"No active editor found"}}case"selections":{let e=Lt();return e!=null?{status:"success",selections:e}:{status:400,error:"No active editor found"}}case"reload":return ao.commands.executeCommand("workbench.action.reloadWindow"),{status:"success"}}}async function po(n){switch(n){case"markForReload":return io(!0),{status:"success",message:"Marked for reload"}}}var ao,lo=R(()=>{"use strict";V();ke();Ke();je();ao=v(require("vscode"))});var ho={};ze(ho,{activate:()=>hn,deactivate:()=>gn,respondToCompleteMessage:()=>fo});function hn(n){fn==="darwin"&&(p.info("ChatGPT desktop bridge active"),W.startServer(n,fo),Ie(),p.info("Desktop bridge registered"))}function gn(){W.deregister()}async function fo(n,e){try{let t=JSON.parse(e),o=kt(t.command);if(!o){re(n,{status:404,error:"Unknown endpoint"});return}if(!mo.workspace.isTrusted&&o!=="ping"){p.warn("Desktop bridge: untrusted workspace"),re(n,{status:405,error:"The workspace must be trusted for the extension to read content."});return}let s=await vn(o,t.payload);s.status===400&&p.error("Desktop bridge error for command:",t.command),re(n,s)}catch(t){p.error("Desktop bridge: error processing message:",t),re(n,{success:!1,error:"Error handling message"})}}async function vn(n,e){let{category:t}=Ee[n];switch(t){case"queryGet":return co(n);case"queryPost":return po(n);case"mutationPost":return Jt(n,e)}}var uo,mo,fn,go=R(()=>{"use strict";V();Xt();We();lo();Ke();Ve();P();uo=v(require("os")),mo=v(require("vscode")),fn=uo.platform()});var wn={};ze(wn,{activate:()=>yn});module.exports=Oo(wn);pe();P();var ot=v(require("os")),nt=v(require("path")),w=v(require("vscode")),Fo=5173,Uo=`http://localhost:${Fo}`,qo="/src/main.tsx",$=class n{constructor(e,t,o,s){this.extensionUri=e;this.codexMcpConnection=t;this.fetchWrapper=o;this.ideContextConnection=s;this.subscriptions.push(w.commands.registerCommand("chatgpt.implementTodo",async({line:r,fileName:a,comment:i})=>{await D();let c={fileName:a,line:r,comment:i};this.sidebarPanel&&this.webviewReady?this.postMessageToView(this.sidebarPanel.webview,{type:"implement-todo",...c}):this.pendingImplementTodo=c})),this.subscriptions.push(w.workspace.onDidChangeWorkspaceFolders(()=>{this.sidebarPanel&&this.postMessageToView(this.sidebarPanel.webview,{type:"workspace-roots-updated"}),this.editorPanel&&this.postMessageToView(this.editorPanel.webview,{type:"workspace-roots-updated"})}))}static viewType="chatgpt.sidebarView";static providerName="webview";sidebarPanel;editorPanel;subscriptions=[];mcpProviderDisposable;webviewReady=!1;pendingImplementTodo=null;pendingContextFiles=[];pendingNavigationRoutes=[];async resolveWebviewView(e,t,o){this.sidebarPanel=e;let{webview:s}=e,r=w.Uri.joinPath(this.extensionUri,"webview");s.options={enableScripts:!0,enableCommandUris:!1,localResourceRoots:[r]},s.onDidReceiveMessage(a=>{if(a.type==="ready"){if(this.webviewReady=!0,this.pendingImplementTodo&&(this.postMessageToView(s,{type:"implement-todo",...this.pendingImplementTodo}),this.pendingImplementTodo=null),this.pendingContextFiles.length>0){for(let i of this.pendingContextFiles)this.postMessageToView(s,{type:"add-context-file",file:i});this.pendingContextFiles=[]}if(this.pendingNavigationRoutes.length>0){for(let{path:i,state:c}of this.pendingNavigationRoutes)this.postMessageToView(s,{type:"navigate-to-route",path:i,state:c});this.pendingNavigationRoutes=[]}}this.handleMessage(s,a)}),this.mcpProviderDisposable?.dispose(),this.mcpProviderDisposable=this.codexMcpConnection.registerProvider(n.providerName,{onResult:a=>{this.postMessageToView(s,{type:"mcp-message",message:a})},onRequest:a=>{this.postMessageToView(s,{type:"mcp-request",id:a.id,method:a.method,params:a.params})},onNotification:a=>{let{method:i,params:c}=a;this.postMessageToView(s,{type:"mcp-notification",method:i,params:c})}}),this.subscriptions.push(this.ideContextConnection.onIdeContextChange(()=>{this.postMessageToView(s,{type:"ide-context-updated"})})),s.html=await this.getWebviewContent(s),this.subscriptions.push(e.onDidDispose(()=>{this.sidebarPanel=void 0,this.webviewReady=!1,this.mcpProviderDisposable?.dispose(),this.mcpProviderDisposable=void 0})),this.subscriptions.push(e.onDidChangeVisibility(()=>{w.commands.executeCommand("setContext","chatgpt.sidebarView.visible",e.visible)}))}triggerNewChatViaWebview(){this.sidebarPanel&&this.webviewReady&&this.postMessageToView(this.sidebarPanel.webview,{type:"new-chat"})}postMessageToView(e,t){let o=JSON.stringify(t);e.postMessage(o)}addContextFile(e){let t={type:"add-context-file",file:e};this.sidebarPanel&&this.webviewReady?this.postMessageToView(this.sidebarPanel.webview,t):this.pendingContextFiles.push(e)}navigateToRoute(e,t){let o={type:"navigate-to-route",path:e,state:t};this.sidebarPanel&&this.webviewReady?this.postMessageToView(this.sidebarPanel.webview,o):this.pendingNavigationRoutes.push({path:e,state:t})}async handleMessage(e,t){switch(t.type){case"ready":break;case"mcp-request":{let{id:o,method:s,params:r}=t.request;this.codexMcpConnection.sendRequest(n.providerName,String(o),s,r);break}case"mcp-notification":{let{method:o,params:s}=t.request;this.codexMcpConnection.sendNotification(o,s);break}case"mcp-response":{let{id:o,result:s}=t.response;this.codexMcpConnection.sendResponse(o,s);break}case"open-in-browser":{w.env.openExternal(w.Uri.parse(t.url));break}case"open-extension-settings":{w.commands.executeCommand("workbench.action.openSettings","@ext:openai.chatgpt");break}case"open-keyboard-shortcuts":{w.commands.executeCommand("workbench.action.openGlobalKeybindings","chatgpt");break}case"open-config-toml":{let o=nt.join(ot.homedir(),".codex","config.toml");w.commands.executeCommand("vscode.open",w.Uri.file(o));break}case"show-diff":{this.showDiff({unifiedDiff:t.unifiedDiff});break}case"update-diff-if-open":{this.editorPanel&&this.postMessageToView(this.editorPanel.webview,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:t.unifiedDiff}});break}case"fetch":{let o=await this.fetchWrapper.fetch(t);this.postMessageToView(e,o);break}case"cancel-fetch":{this.fetchWrapper.cancel(t.requestId);break}case"fetch-stream":{this.fetchWrapper.stream(t,o=>this.postMessageToView(e,o));break}case"cancel-fetch-stream":{this.fetchWrapper.cancelStream(t.requestId);break}case"log-message":{let{level:o,message:s}=t;switch(o){case"trace":p.trace(s);break;case"debug":p.debug(s);break;case"info":p.info(s);break;case"warning":p.warn(s);break;case"error":p.error(s);break}break}}}async getWebviewContent(e){return this.getWebviewContentProduction(e)}async getWebviewContentProduction(e){let t=w.Uri.joinPath(this.extensionUri,"webview"),o=w.Uri.joinPath(t,"index.html"),s=await w.workspace.fs.readFile(o),r=new TextDecoder("utf-8").decode(s),a=e.asWebviewUri(t).toString()+"/",i=tt(a),c=["default-src 'none'",`img-src ${e.cspSource} https: data: blob:`,`script-src ${e.cspSource}`,`style-src ${e.cspSource} 'unsafe-inline'`,`font-src ${e.cspSource}`,`connect-src ${e.cspSource}`].join("; ")+";",u=tt(c);return r.replace("<!-- PROD_BASE_TAG_HERE -->",`<base href="${i}">`).replace("<!-- PROD_CSP_TAG_HERE -->",`<meta http-equiv="Content-Security-Policy" content="${u}">`)}getWebviewContentDevelopment(){return`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="${w.Uri.parse(Uo).toString()}">

    <!-- Hot reloading code from Vite -->
    <script type="module">
        import RefreshRuntime from "/@react-refresh"
        RefreshRuntime.injectIntoGlobalHook(window)
        window.$RefreshReg$ = () => {}
        window.$RefreshSig$ = () => (type) => type
        window.__vite_plugin_react_preamble_installed__ = true
    </script>
    <script type="module" src="/@vite/client"></script>
    <script type="module" src="${qo}"></script>
    <script src="http://localhost:8097"></script>
</head>
<body tabindex="0" style="outline: none">
    <div id="root"></div>
</body>
</html>`}dispose(){this.subscriptions.forEach(e=>e.dispose())}async showDiff(e){if(this.editorPanel)this.editorPanel.reveal(w.ViewColumn.One),this.postMessageToView(this.editorPanel.webview,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:e.unifiedDiff}});else{let t=w.Uri.joinPath(this.extensionUri,"webview");this.editorPanel=w.window.createWebviewPanel("codexEditorView","Codex",w.ViewColumn.One,{enableScripts:!0,retainContextWhenHidden:!0,localResourceRoots:[t]}),this.subscriptions.push(this.editorPanel.onDidDispose(()=>{this.editorPanel=void 0}));let{webview:o}=this.editorPanel;o.html=await this.getWebviewContent(o),this.subscriptions.push(o.onDidReceiveMessage(async s=>{s.type==="ready"&&this.postMessageToView(o,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:e.unifiedDiff}}),this.handleMessage(o,s)}))}}};function tt(n){return n.replace(/["<&]/g,e=>{switch(e){case'"':return"&quot;";case"<":return"&lt;";case"&":return"&amp;";default:return e}})}P();var De=v(require("vscode"));async function D(){try{await De.commands.executeCommand("workbench.view.extension.codexViewContainer"),await De.commands.executeCommand(`${$.viewType}.focus`)}catch(n){p.error(`Failed to focus Codex view: ${n instanceof Error?n.message:String(n)}`)}}var st=v(require("path")),le=v(require("vscode"));async function rt(n){let e=le.window.activeTextEditor;if(!e)return;let t=e.document.uri;if(t.scheme!=="file")return;let o=e.selection.start.line+1,s=e.selection.end.line+1;e.selection.end.character===0&&e.selection.end.line>e.selection.start.line&&s--;let r=t.fsPath,a=st.basename(r),i=o!=null?`${a}:${o}`+(s!=null&&s!==o?`:${s}`:""):a;await D(),n.addContextFile({label:i,path:le.workspace.asRelativePath(r),fsPath:r,startLine:o,endLine:s})}var it=require("crypto"),Oe=class n{constructor(e){this.mcpConnection=e;let t=this.mcpConnection.registerProvider(n.providerName,{onNotification:o=>this.handleNotification(o),onResult:o=>this.handleResult(o)});this.disposables.push(t)}static providerName="auth";authStatus;disposables=[];pending=new Map;updateToken(e){let t=(0,it.randomUUID)(),o=new Promise((s,r)=>{this.pending.set(t,{resolve:s,reject:r})});return this.mcpConnection.sendRequest(n.providerName,t,"getAuthStatus",{includeToken:!0,refreshToken:!!e}),o}async getToken(e){return this.authStatus&&!e?this.authStatus.authToken:this.updateToken(e)}resolve(e,t){let o=this.pending.get(e);o&&(this.pending.delete(e),o.resolve(t))}reject(e,t){let o=this.pending.get(e);o&&(this.pending.delete(e),o.reject(t))}handleResult(e){if(typeof e.id!="string")return;if(e.error){this.reject(e.id,e.error);return}let t=e.result??null;this.authStatus=t??void 0,this.resolve(e.id,this.authStatus?.authToken??null)}handleNotification(e){e.method==="codex/event/auth_status_change"&&(this.authStatus=void 0,this.updateToken())}dispose(){for(let e of this.disposables)e.dispose();this.disposables.length=0,this.pending.clear()}};function at(n){return new Oe(n)}K();K();var $o="http://localhost:8000/api",Go="https://chatgpt.com/backend-api";function Ho(){switch(k().get(Qe)){case"localhost":return $o;case"production":default:return Go}}function Ne(n){return n.startsWith("data:")||n.startsWith("http")?n:`${Ho()}/${n.replace(/^\//,"")}`}P();function Vo(n){let e=n.split(/\r?\n/),t,o=[];for(let r of e)r.startsWith("event:")?t=r.slice(6).trim():r.startsWith("data:")&&o.push(r.slice(5).trim());if(o.length===0)return null;let s=o.join(`
`);try{return{event:t,data:JSON.parse(s)}}catch{return null}}function Bo(n){let e=n.indexOf(`\r
\r
`),t=n.indexOf(`

`);return e===-1&&t===-1?[-1,0]:e===-1?[t,2]:t===-1?[e,4]:e<t?[e,4]:[t,2]}function Wo(n,e){return{async next(){if(e.aborted)return{done:!0,value:void 0};let{value:t,done:o}=await n.read();return o||t==null?{done:!0,value:void 0}:{done:!1,value:t}},[Symbol.asyncIterator](){return this}}}async function*ct(n,e){let t=n.getReader(),o=new TextDecoder,s="",r=Wo(t,e);try{for await(let a of r){s+=o.decode(a,{stream:!0});let i,c;for(;[i,c]=Bo(s),i>=0;){let u=s.slice(0,i);s=s.slice(i+c);let m=Vo(u);!m||m.event==="heartbeat"||(yield m)}}}finally{t.releaseLock()}}function pt(n){return!!n&&typeof n=="object"&&n.name==="AbortError"}function ee(n){return new Promise(e=>setTimeout(e,n))}var me="codex_vscode",dt="vscode://codex/",z=3,jo=300,Ko=2e3,ue=class{constructor(e,t,o){this.authProvider=e;this.extensionFetchHandler=t;this.userAgentProvider=o}abortSignals=new Map;streamControllers=new Map;shouldRetryStatus(e){return e===408||e===425||e===429||e>=500&&e<=599}backoffDelay(e){let t=Math.min(Ko,jo*2**e),o=t*.2*(Math.random()-.5)*2;return Math.max(0,Math.floor(t+o))}buildHeaders(e,t,o){let s={...e??{}},r=i=>Object.keys(s).some(c=>c.toLowerCase()===i);if(o.attachAuth&&t&&!r("authorization")){s.Authorization=`Bearer ${t}`;try{let i=JSON.parse(Buffer.from(t.split(".")[1],"base64url").toString("utf8"))["https://api.openai.com/auth"]?.chatgpt_account_id;i&&(s["ChatGPT-Account-Id"]=i)}catch{}}o.method!=="GET"&&!r("content-type")&&(s["Content-Type"]="application/json"),r("originator")||(s.originator=me);let a=this.userAgentProvider.getUserAgent();return a&&!r("user-agent")&&(s["User-Agent"]=a),s}shouldAttachAuth(e){let o=new URL(e).host.toLowerCase();return o==="localhost:8000"||o==="localhost"||o.endsWith(".openai.com")||o==="openai.com"||o==="chatgpt.com"||o.endsWith(".chatgpt.com")}async fetch(e){try{let t=new AbortController;if(this.abortSignals.set(e.requestId,t),t.signal.addEventListener("abort",()=>({type:"fetch-response",responseType:"error",error:"Request cancelled",requestId:e.requestId,status:499})),e.url.startsWith(dt)){let i=await this.extensionFetchHandler.handleVSCodeRequest(e.url.slice(dt.length),e.body?JSON.parse(e.body):void 0);return{type:"fetch-response",responseType:"success",requestId:e.requestId,status:200,headers:{},bodyJsonString:JSON.stringify(i)}}let o=Ne(e.url),s=await this.authProvider.getToken(),r=this.shouldAttachAuth(o),a=async(i,c)=>{if(r&&!zo(c))return{type:"fetch-response",responseType:"error",requestId:e.requestId,status:401,error:`Cannot fetch ${e.url} without ChatGPT auth.`};let u=this.buildHeaders(e.headers,c,{method:e.method,attachAuth:r}),m=Object.keys(u).some(h=>h.toLowerCase()==="authorization");try{let h=e.body,d=Object.keys(u).find(E=>E.toLowerCase()==="x-codex-base64");if(d&&u[d]==="1"){if(e.body)try{h=Buffer.from(e.body,"base64")}catch{h=e.body}delete u[d]}let g=await fetch(o,{method:e.method,headers:u,body:h,signal:t.signal});if(g.status>=200&&g.status<300){let E=g.headers.get("content-type")||"",Y;if(E.includes("application/json")){let q=await g.json();Y=JSON.stringify(q)}else{let q=await g.arrayBuffer(),j=Buffer.from(q).toString("base64");Y=JSON.stringify({base64:j,contentType:E})}this.abortSignals.delete(e.requestId);let ae={};return g.headers.forEach((q,j)=>{j!=="authorization"&&(ae[j]=q)}),{type:"fetch-response",responseType:"success",requestId:e.requestId,status:g.status,headers:ae,bodyJsonString:Y}}if(g.status===401&&m&&i<z){let E=await this.authProvider.getToken(!0);if(E&&E!==c)return a(i+1,E)}if(this.shouldRetryStatus(g.status)&&i<z){let E=this.backoffDelay(i);return await ee(E),a(i+1,c)}let S=g.headers.get("cf-ray");return g.status===404?p.info(`Error fetching ${e.url}: ${g.status} ${g.statusText} (${S})`):p.error(`Error fetching ${e.url}: ${g.status} ${g.statusText} (${S})`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:g.status,error:g.statusText}}catch(h){if(t.signal.aborted)return{type:"fetch-response",responseType:"error",error:"Request cancelled",requestId:e.requestId,status:499};if(i<z){let d=this.backoffDelay(i);return await ee(d),a(i+1,c)}return p.error(`Error fetching ${e.url}: ${String(h)}`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:500,error:h instanceof Error?h.message:"Unknown error"}}};return a(0,s)}catch(t){return p.error(`Error fetching ${e.url}: ${t}`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:500,error:t instanceof Error?t.message:"Unknown error"}}finally{this.abortSignals.delete(e.requestId)}}async stream(e,t){let o=new AbortController;this.streamControllers.set(e.requestId,o);let s=Ne(e.url),r=await this.authProvider.getToken(),a=this.shouldAttachAuth(s),i=async(c,u)=>{let m=this.buildHeaders(e.headers,u,{method:e.method,attachAuth:a}),h=Object.keys(m).some(d=>d.toLowerCase()==="authorization");try{let d=await fetch(s,{method:e.method,headers:m,body:e.body,signal:o.signal});if(d.status===200&&d.body!=null){for await(let f of ct(d.body,o.signal))t({type:"fetch-stream-event",requestId:e.requestId,event:f.event,data:f.data});t({type:"fetch-stream-complete",requestId:e.requestId});return}if(d.status===401&&h&&c<z){let f=await this.authProvider.getToken(!0);if(f&&f!==u){await i(c+1,f);return}}if(this.shouldRetryStatus(d.status)&&c<z){let f=this.backoffDelay(c);await ee(f),await i(c+1,u);return}t({type:"fetch-stream-error",requestId:e.requestId,error:`${d.status} ${d.statusText}`})}catch(d){if(o.signal.aborted||pt(d)){t({type:"fetch-stream-complete",requestId:e.requestId});return}if(c<z){let f=this.backoffDelay(c);await ee(f),await i(c+1,u);return}t({type:"fetch-stream-error",requestId:e.requestId,error:d instanceof Error?d.message:"Unknown error"})}};try{await i(0,r)}finally{this.streamControllers.delete(e.requestId)}}cancel(e){let t=this.abortSignals.get(e);t&&(t.abort(),this.abortSignals.delete(e))}cancelStream(e){let t=this.streamControllers.get(e);t&&(t.abort(),this.streamControllers.delete(e))}};function zo(n){return n?/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(n):!1}pe();function te(){if(!0){let{platform:n,arch:e}=process,t,o;switch(n){case"win32":t="windows";break;case"darwin":t="macos";break;default:t="linux";break}switch(e){case"x64":o="x86_64";break;case"arm64":o="aarch64";break;default:throw new Error(`unrecognized architecture: ${e}`)}return`bin/${`${t}-${o}`}`}return"bin"}P();var lt=require("child_process");var G={CLI_EXECUTABLE:"cliExecutable",COMMENT_CODELENS_ENABLED:"commentCodeLensEnabled",OPEN_ON_STARTUP:"openOnStartup"};var oe={HAS_PROBABLY_SEEN_2025_08_27_NUX:"hasProbablySeen2025-08-27-nux",NUX_2025_09_15:"viewed2025-09-15-nux",NUX_2025_09_15_FULL_CHATGPT_AUTH_VIEWED:"viewed2025-09-15-full-chatgpt-auth-nux",NUX_2025_09_15_APIKEY_AUTH_VIEWED:"viewed2025-09-15-apikey-auth-nux",NUX_2025_09_15_GPT5_CODEX_ONLY_CHATGPT_AUTH_VIEWED:"viewed2025-09-15-gpt5-codex-only-chatgpt-auth-nux"};var ut=v(require("readline")),N=v(require("vscode"));async function mt(n,e){let t=Jo(n),o=process.platform==="win32"?";":":",s=process.env.PATH+o+N.Uri.joinPath(n,te()).fsPath,r=(0,lt.spawn)(t,["mcp"],{stdio:["pipe","pipe","pipe"],env:{...process.env,PATH:s,RUST_LOG:"warn",CODEX_INTERNAL_ORIGINATOR_OVERRIDE:me}});if(r.pid==null)throw new Error(`Failed to spawn codex mcp process at ${t}`);let a=new _e(r,e),i=1;{let c={jsonrpc:"2.0",id:i,method:"initialize",params:{protocolVersion:"2025-06-18",capabilities:{roots:{listChanged:!0},elicitation:{}},clientInfo:{name:Yo(),title:"Codex Extension",version:Zo()}}};r.stdin.destroyed||r.stdin.write(JSON.stringify(c)+`
`)}return await a.whenInitialized,a}var _e=class{constructor(e,t){this.proc=e;this.userAgentProvider=t;e.on("error",o=>{p.error(`codex mcp process error: ${o}`)}),e.on("exit",(o,s)=>{o!==0?p.error(`codex mcp process exited with code ${o} and signal ${s}`):p.info("codex mcp process exited successfully.")}),e.stderr&&e.stderr.on("data",o=>{let s=Xo(o.toString().trim());if(s){let{level:r,message:a}=Qo(s),i="CLI:";switch(r){case"trace":case"debug":case"info":p.info(`${i} ${a}`);break;case"warn":p.warn(`${i} ${a}`);break;case"error":p.error(`${i} ${a}`);break}}}),this.whenInitialized=new Promise((o,s)=>{this.resolveInit=o,this.rejectInit=s}),this.rl=ut.createInterface({input:e.stdout}),this.rl.on("line",o=>{let s=o.trim(),r;try{r=JSON.parse(s)}catch(a){p.error(`unable to parse stdout from codex mcp: ${a}`);return}if(!this.initialized){if("id"in r&&("result"in r||"error"in r)&&r.id===1){if("error"in r&&r.error){let a=new Error(`Failed to initialize local agent: ${JSON.stringify(r.error)}`);this.rejectInit?.(a)}else{let a=r.result;this.userAgentProvider.setUserAgent(a.serverInfo.user_agent??me),this.initialized=!0,this.resolveInit?.()}return}p.warn(`Dropping MCP message received before initialization: ${s}`);return}this.routeIncomingMessage(r)})}rl;providers=new Map;initialized=!1;whenInitialized;resolveInit;rejectInit;registerProvider(e,t){if(this.providers.has(e))throw new Error(`Provider already registered: ${e}`);return this.providers.set(e,t),new N.Disposable(()=>{this.providers.delete(e)})}sendRequest(e,t,o,s){let a={jsonrpc:"2.0",id:`${e}:${t}`,method:o,params:s};this.sendMessage(a)}sendNotification(e,t){let o={jsonrpc:"2.0",method:e,params:t};this.sendMessage(o)}sendResponse(e,t){let o={jsonrpc:"2.0",id:e,result:t};this.sendMessage(o)}sendMessage(e){let{stdin:t}=this.proc;t.destroyed||t.write(JSON.stringify(e)+`
`)}routeIncomingMessage(e){if(this.isMcpResponseMessage(e)){let t=e.id;if(typeof t=="string"&&t.includes(":")){let[o,...s]=t.split(":"),r=s.join(":"),a=this.providers.get(o);if(a?.onResult){let i={...e,id:r};a.onResult(i)}return}p.warn(`Received MCP response with id=${JSON.stringify(t)} but no provider namespace`);return}if(this.isMcpRequestMessage(e)){for(let[,t]of this.providers)t.onRequest?.(e);return}if(typeof e.method=="string"){let{method:t,params:o}=e;for(let[,s]of this.providers)s.onNotification?.({jsonrpc:"2.0",method:t,params:o});return}p.error(`Received unknown MCP message: ${JSON.stringify(e)}`)}isMcpResponseMessage(e){return"id"in e&&("result"in e||"error"in e)}isMcpRequestMessage(e){return typeof e.method=="string"&&"id"in e&&e.id!=null}dispose(){this.rl.close(),this.proc.kill()}};function Jo(n){let e=k().get(G.CLI_EXECUTABLE);if(e&&e.trim().length>0)return e;{let t=process.platform==="win32"?"codex.exe":"codex",o=te();return N.Uri.joinPath(n,`${o}/${t}`).fsPath}}function Xo(n){return n.replace(/\x1b\[[0-9;]*m/g,"")}function Qo(n){let e=n.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z\s+(\w+)\s+(.+)$/);if(e){let t=e[1].toLowerCase();return t==="trace"||t==="debug"||t==="info"||t==="warn"||t==="error"?{level:t,message:e[2]}:{level:"error",message:e[2]}}return{level:"error",message:n}}function Yo(){let n=N.env.appName??"",e=n.toLowerCase();return e.includes("cursor")?"Cursor":e.includes("windsurf")?"Windsurf":e.includes("visual studio code")||e==="code"||e.startsWith("code ")||e.endsWith(" code")||e.includes("vscode")?"VS Code":n||"VS Code"}function Zo(){let e=N.extensions.getExtension("openai.chatgpt")?.packageJSON?.version;return typeof e=="string"&&e.trim().length>0?e:"0.0.0"}K();var fe=class{constructor(e,t=[],o=[],s){this.child=e;this.stdoutChunks=t;this.stderrChunks=o;this.promise=s.then(({code:r,signal:a})=>({type:"resolve",code:r,signal:a}),r=>({type:"reject",error:r}))}result=null;promise;check(){return this.wait().then(({stdout:e,stderr:t,code:o,signal:s})=>{if(o===0)return{stdout:e,stderr:t};throw new Error(`process exited with code ${o}, signal ${s}`)})}wait(){return this.promise.then(e=>{switch(e.type){case"resolve":{let{code:t,signal:o}=e;return{stdout:Buffer.concat(this.stdoutChunks).toString("utf8"),stderr:Buffer.concat(this.stderrChunks).toString("utf8"),code:t,signal:o}}case"reject":throw e.error}})}getStdout(){return Buffer.concat(this.stdoutChunks)}getStderr(){return Buffer.concat(this.stderrChunks)}getExitCode(){return this.result?.type==="resolve"?this.result.code:null}isDone(){return this.result!=null}kill(){this.child.kill()}};var ft=require("child_process");function I({args:n,cwd:e}){let t=(0,ft.spawn)(n[0],n.slice(1),{cwd:e,env:{...process.env},stdio:["ignore","pipe","pipe"]});if(!t.pid)throw new Error(`failed to start process from ${e}: \`${n.join(" ")}\``);let o=[],s=[],r=new Promise((a,i)=>{t.stdout?.on("data",c=>{o.push(c)}),t.stderr?.on("data",c=>{s.push(c)}),t.on("exit",(c,u)=>{a({code:c,signal:u})}),t.on("error",c=>{i(c)})});return new fe(t,o,s,r)}P();async function he(n){try{let e=I({args:["git","rev-parse","--show-toplevel"],cwd:n}),{stdout:t,code:o}=await e.wait();if(o===0)return t.trim()}catch{p.info(`getGitRoot: ${n} is not a git repository`)}return null}P();function ht(n,e){let t=new Set,o=new Set,s=new Set,r=null,a=[n,e].filter(Boolean).join(`
`),i=(A,y)=>{let l=(y??"").trim();if(!l)return;let C=l.charAt(0),ko=l.charAt(l.length-1),Me=l;(C==="'"||C==='"')&&ko===C&&l.length>=2&&(Me=l.slice(1,-1)),Me&&A.add(Me)},c=(A,y)=>{for(let l of y)if(A[l])return A[l]},u=/^(?:Applied patch(?: to)?\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+cleanly\.?)$/i,m=/^(?:Applied patch(?: to)?\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+with conflicts\.?)$/i,h=/^(?:Applying patch\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+with\s+\d+\s+rejects?\.{0,3})$/i,d=/^(?:Checking patch\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\.\.\.)$/i,f=/^(?:Performing three-way merge|Falling back to three-way merge)\.\.\.$/i,g=/^Failed to perform three-way merge\.\.\.$/i,S=/^Falling back to direct application\.\.\.$/i,E=/^U\s+(?<path>.+)$/,Y=/^error:\s+patch failed:\s+(?<path>.+?)(?::\d+)?(?:\s|$)/i,ae=/^error:\s+(?<path>.+?):\s+patch does not apply$/i,q=/^(?:error: )?repository lacks the necessary blob to (?:perform|fall back on) 3-?way merge\.?$/i,j=/^error:\s+(?<path>.+?):\s+does not match index\b/i,vo=/^error:\s+(?<path>.+?):\s+does not exist in index\b/i,yo=/^error:\s+(?<path>.+?)\s+already exists in (?:the )?working directory\b/i,wo=/^error:\s+patch failed:\s+(?<path>.+?)\s+File exists/i,bo=/^error:\s+path\s+(?<path>.+?)\s+has been renamed\/deleted/i,xo=/^error:\s+cannot apply binary patch to\s+['"]?(?<path>.+?)['"]?\s+without full index line$/i,Co=/^error:\s+binary patch does not apply to\s+['"]?(?<path>.+?)['"]?$/i,Ro=/^error:\s+binary patch to\s+['"]?(?<path>.+?)['"]?\s+creates incorrect result\b/i,Po=/^error:\s+cannot read the current contents of\s+['"]?(?<path>.+?)['"]?$/i,So=/^Skipped patch\s+['"]?(?<path>.+?)['"]\.$/i,Eo=/^warning:\s*Cannot merge binary files:\s+(?<path>.+?)\s+\(ours\s+vs\.\s+theirs\)/i;for(let A of a.split(/\r?\n/)){let y=A.trim();if(!y)continue;let l;if(l=y.match(u)){let C=c(l.groups??{},["qpath","path"]);i(t,C),r=C??r,s.delete(C??""),o.delete(C??"");continue}if(l=y.match(m)){let C=c(l.groups??{},["qpath","path"]);i(s,C),r=C??r,t.delete(C??""),o.delete(C??"");continue}if(l=y.match(h)){let C=c(l.groups??{},["qpath","path"]);i(s,C),r=C??r,t.delete(C??""),o.delete(C??"");continue}if(l=y.match(E)){i(s,l.groups?.path),r=l.groups?.path??r,t.delete(l.groups?.path??""),o.delete(l.groups?.path??"");continue}if(l=y.match(d)){r=c(l.groups??{},["qpath","path"])??r;continue}if((l=y.match(Y))||(l=y.match(ae))){i(o,l.groups?.path),r=l.groups?.path??r;continue}if(!(f.test(y)||S.test(y))){if(g.test(y)){r&&(i(o,r),t.delete(r),s.delete(r));continue}if(q.test(y)){r&&(i(o,r),t.delete(r),s.delete(r));continue}if((l=y.match(j))||(l=y.match(vo))||(l=y.match(yo))||(l=y.match(wo))||(l=y.match(bo))||(l=y.match(xo))||(l=y.match(Co))||(l=y.match(Ro))||(l=y.match(Po))||(l=y.match(So))){i(o,l.groups?.path),r=l.groups?.path??r,t.delete(l.groups?.path??""),s.delete(l.groups?.path??"");continue}if(l=y.match(Eo)){i(s,l.groups?.path),r=l.groups?.path??r,t.delete(l.groups?.path??""),o.delete(l.groups?.path??"");continue}}}for(let A of s)t.delete(A),o.delete(A);for(let A of t)o.delete(A);return{appliedPaths:Array.from(t).sort(),skippedPaths:Array.from(o).sort(),conflictedPaths:Array.from(s).sort()}}var _=v(require("fs/promises")),gt=v(require("os")),ge=v(require("path"));async function vt({cwd:n,diff:e,revert:t}){let o=await he(n);if(!o)throw new Error(`${n} is not a git repository`);let s=await _.mkdtemp(ge.join(gt.tmpdir(),"codex-apply-")),r=ge.join(s,"patch.diff");await _.writeFile(r,e,"utf8"),t&&await en(o,e);let a=["git","apply",t?"-R":null,"--3way",r].filter(Boolean),i=I({args:a,cwd:o}),{code:c,stdout:u,stderr:m}=await i.wait();p.info(`applyPatch revert: ${t}, code: ${c}, stdout: ${u}, stderr: ${m}`);let{appliedPaths:h,skippedPaths:d,conflictedPaths:f}=ht(u,m);return await _.rm(s,{recursive:!0,force:!0}),{status:c===0?"success":c===1?"partial-success":"error",appliedPaths:h,skippedPaths:d,conflictedPaths:f}}async function en(n,e){let t=tn(e),o=(await Promise.all(t.map(async s=>{try{return await _.access(ge.join(n,s)),s}catch{return p.info(`Skipping staging ${s} because it does not exist in the working tree`),null}}))).filter(s=>!!s);if(o.length>0){let s=["git","add","--",...o],a=await I({args:s,cwd:n}).wait();p.info(`Staged ${o.length} files: ${a.code}`)}}function tn(n){let e=new Set,t=/^diff --git a\/(.*?) b\/(.*)$/gm,o;for(;(o=t.exec(n))!=null;){let[s,r,a]=o;r&&r!=="/dev/null"&&e.add(r),a&&a!=="/dev/null"&&e.add(a)}return Array.from(e)}K();P();P();var yt=v(require("fs")),J=v(require("path")),H=v(require("vscode"));async function wt(n,e=10){let t=H.workspace.workspaceFolders??[];if(n.trim().length===0||t.length===0)return[];let o=[],s=`**/*${on(n)}*`,r=nn();for(let a of t){if(o.length>=e)break;try{let c=I({args:[r??"rg","--files","--iglob",s],cwd:a.uri.fsPath}),{stdout:u,code:m}=await c.wait();if(m!==0)return[];let h=u.split(/\r?\n/).map(d=>d.trim()).filter(Boolean);for(let d of h){if(o.length>=e)break;let f=J.isAbsolute(d)?d:J.join(a.uri.fsPath,d),g=J.basename(f).replace(/\\/g,"/"),S=H.workspace.asRelativePath(f).replace(/\\/g,"/");o.push({label:g,path:S,fsPath:f})}}catch(i){p.warn(`rg search failed in ${a.uri.fsPath}: ${String(i)}`)}}return o}function on(n){let e=["*","?","[","]","{","}","!","\\"],t="";for(let o of n)t+=e.includes(o)?"\\"+o:o;return t}function nn(){try{let n=H.extensions.getExtension("openai.chatgpt");if(!n)return null;let e=process.platform==="win32"?"rg.exe":"rg",t=te(),o=H.Uri.joinPath(n.extensionUri,t,e).fsPath;return yt.existsSync(o)?o:null}catch{return null}}var Le=v(require("os")),bt=v(require("path"));var b=v(require("vscode")),ve=class{constructor(e,t,o){this.authProvider=e;this.ideContextConnection=t;this.globalState=o}handlers={"workspace-roots":async()=>({roots:b.workspace.workspaceFolders?.map(e=>e.uri.fsPath)??[]}),"has-custom-cli-executable":async()=>({hasCustomCliExecutable:(k().get(G.CLI_EXECUTABLE)??"").trim().length>0}),"account-info":async()=>{let e=await this.authProvider.getToken();if(!e)return{accountId:null,plan:null,email:null};try{let t=JSON.parse(Buffer.from(e.split(".")[1],"base64url").toString("utf8")),o=t["https://api.openai.com/auth"]??{},s=t["https://api.openai.com/profile"]??{},r=o?.chatgpt_account_id??null,a=o?.chatgpt_plan_type??null,i=s?.email??null;if(r&&a)return{type:"success",accountId:r,plan:a,email:i}}catch{p.error("Unable to extract account id and plan from auth token.")}return{accountId:null,plan:null,email:null}},"openai-api-key":async()=>({value:process.env.OPENAI_API_KEY??null}),"find-files":async({query:e})=>({files:await wt(e,10)??[]}),"ide-context":async()=>({ideContext:this.ideContextConnection.getIdeContext()}),"apply-patch":async e=>vt(e),"open-file":async({path:e,line:t,column:o})=>{let s=typeof t=="number"?t:void 0,r=typeof o=="number"?o:1,a=e.replace(/^([ab])[\\/]/,""),i=b.workspace.workspaceFolders??[],c=async h=>{try{let d=await b.workspace.openTextDocument(h),f=s!=null?new b.Range(new b.Position(Math.max(0,s-1),Math.max(0,r-1)),new b.Position(Math.max(0,s-1),Math.max(0,r-1))):void 0;return await b.window.showTextDocument(d,f?{preview:!1,selection:f}:void 0),!0}catch{return!1}};if(bt.isAbsolute(a)){let h=await c(b.Uri.file(a));return h||p.error(`Failed to open absolute path: ${a}`),{success:h}}let u=a.split(/[\\/]+/).filter(Boolean),m=!1;for(let h of i){if(m)break;let d=b.Uri.joinPath(h.uri,...u);if(await c(d)){m=!0;break}let f=u.indexOf(h.name);if(f!==-1){let g=b.Uri.joinPath(h.uri,...u.slice(f+1));if(await c(g)){m=!0;break}}}if(!m&&a.length>0)try{let h=`**/${a.replace(/\\/g,"/")}`,d=await b.workspace.findFiles(h,void 0,1);d.length>0&&(m=await c(d[0]))}catch{}if(!m){let h=i.map(d=>d.uri.fsPath).join(", ");p.error(`Failed to resolve and open file from path "${e}" (normalized: "${a}") in workspaces: [${h}]`)}return{success:m}},"git-origins":async()=>{let e=b.workspace.workspaceFolders??[],t=[],o=new Set,s=Le.homedir();return await Promise.all(e.map(async r=>{let a=r.uri.fsPath;try{let i=I({args:["git","rev-parse","--show-toplevel"],cwd:r.uri.fsPath}),{stdout:c,code:u}=await i.wait();u===0&&(a=c.trim())}catch{}try{let i=I({args:["git","config","--get","remote.origin.url"],cwd:a}),{stdout:c,code:u}=await i.wait(),m=u===0?c.trim():null;o.has(a)||(t.push({root:a,originUrl:m}),o.add(a))}catch{o.has(a)||(t.push({root:a,originUrl:null}),o.add(a))}})),{origins:t,homeDir:s}},"git-roots":async()=>{let e=b.workspace.workspaceFolders??[],t=Le.homedir();return{roots:(await Promise.all(e.map(s=>he(s.uri.fsPath)))).filter(s=>s!=null),homeDir:t}},"git-current-branch":async({gitRoot:e})=>{let t=b.workspace.workspaceFolders??[],o=e??t[0]?.uri.fsPath;if(!o)return{branch:null};try{let s=I({args:["git","rev-parse","--abbrev-ref","HEAD"],cwd:o}),{stdout:r,code:a}=await s.wait();if(a===0){let i=r.trim();return{branch:i&&i!=="HEAD"?i:null}}}catch{}return{branch:null}},"get-configuration":async({key:e})=>({value:k().get(e)}),"set-configuration":async({key:e,value:t})=>(await k().update(e,t),{success:!0}),"get-global-state":async({key:e})=>({value:await this.globalState.get(e)}),"set-global-state":async({key:e,value:t})=>{try{return await this.globalState.update(e,t),{success:!0}}catch{return{success:!1}}},"set-vs-context":async({key:e,value:t})=>(await b.commands.executeCommand("setContext",e,t),{success:!0})};handleVSCodeRequest(e,t){return this.handlers[e](t)}};P();var xt=v(require("fs/promises")),Ct=v(require("os")),Fe=v(require("path"));var ye=class{constructor(e){this.context=e}async get(e){let t=this.context.globalState.get(e);if(e===oe.HAS_PROBABLY_SEEN_2025_08_27_NUX&&t==null){let o=sn(),s=Fe.join(o,"sessions"),r;try{r=(await xt.stat(s)).isDirectory(),r&&this.update(oe.HAS_PROBABLY_SEEN_2025_08_27_NUX,!0)}catch{r=!1}return r}return t}async update(e,t){await this.context.globalState.update(e,t)}async dumpNuxState(){let e=Object.entries(oe);for(let[t,o]of e){let s=this.context.globalState.get(o);p.info(`Global state ${t} (${o}): ${s}`)}}async resetNuxState(){await Promise.all(Object.values(oe).map(e=>this.context.globalState.update(e,void 0)))}};function sn(){return process.env.CODEX_HOME??Fe.join(Ct.homedir(),".codex")}var O=v(require("vscode"));function rn(n){return n.path.split("/").pop()??""}function Ue(){return O.window.tabGroups.all.flatMap(n=>n.tabs.filter(e=>e.input?.uri?.scheme==="file").map(e=>({label:e.label,path:O.workspace.asRelativePath(e.input?.uri?.fsPath),fsPath:e.input?.uri?.fsPath})))}function qe(n){return{label:rn(n.document.uri),path:O.workspace.asRelativePath(n.document.uri.fsPath),fsPath:n.document.uri.fsPath,selection:n.selection,activeSelectionContent:n.document.getText(n.selection),selections:n.selections.map(e=>({start:e.start,end:e.end}))}}var we=class{onIdeContextChangeEmitter=new O.EventEmitter;listeners=[];ideContext={activeFile:void 0,openTabs:[]};constructor(){this.listeners.push(O.window.onDidChangeActiveTextEditor(e=>this.onChangeActiveTextEditor(e))),this.listeners.push(O.window.onDidChangeTextEditorSelection(e=>{this.onChangeTextEditorSelection(e)})),this.initIdeContext()}get onIdeContextChange(){return this.onIdeContextChangeEmitter.event}getIdeContext(){return this.ideContext}initIdeContext(){let e=O.window.activeTextEditor;this.ideContext={activeFile:e?qe(e):void 0,openTabs:Ue()},this.onIdeContextChangeEmitter.fire(this.ideContext)}onChangeActiveTextEditor(e){this.ideContext={...this.ideContext,activeFile:e?qe(e):void 0,openTabs:Ue()},this.onIdeContextChangeEmitter.fire(this.ideContext)}onChangeTextEditorSelection(e){e.textEditor.document.uri.scheme==="file"&&(this.ideContext={...this.ideContext,activeFile:qe(e.textEditor),openTabs:Ue()},this.onIdeContextChangeEmitter.fire(this.ideContext))}dispose(){this.listeners.forEach(e=>e.dispose())}};P();var $e=v(require("vscode")),be=class{shellIntegrationSubscription;pendingTerminals=new Map;constructor(){this.shellIntegrationSubscription=$e.window.onDidChangeTerminalShellIntegration(e=>{let{terminal:t}=e,o=this.pendingTerminals.get(t);o&&(o(t),this.pendingTerminals.delete(t))})}createTerminal(e){let t=$e.window.createTerminal(e);return new Promise(o=>{this.pendingTerminals.set(t,o)})}dispose(){this.shellIntegrationSubscription.dispose()}};function Pt(n){let e=[],t=n.length,o=0;function s(i,c){let u=n[i],m=c;for(;m<t&&n[m]===u;)m++;let h=xe(n,m),d=Rt(n,h,"TODO",!0),f=h;for(;f<t&&n[f]!==`
`&&n[f]!=="\r";)f++;if(d!==-1){let g=n.slice(d,f);e.push({body:g.trimEnd(),index:i})}return f}let r=null,a=!1;for(;o<t;){let i=n[o];if(r){a?a=!1:i==="\\"?a=!0:i===r&&(r=null),o++;continue}else if(i==='"'||i==="'"||i==="`"){r=i,o++;continue}if(i==="/"&&o+1<t){let c=n[o+1];if(c==="/"){o=s(o,o+2);continue}if(c==="*"){let u=o,m=o+2,h=n.indexOf("*/",m),d=h===-1?t:h+2,f=n.slice(m,h===-1?t:h);f=f.replace(/^(?:[ \t]*\*?[ \t]*(?:\r?\n|$))+/,"");let g=xe(f,0);f[g]==="*"&&(g=xe(f,g+1));let S=Rt(f,g,"TODO",!0);if(S!==-1){let E=f.slice(S);e.push({body:E.replace(/\s+$/,""),index:u})}o=d;continue}}else if(i==="#"){o=s(o,o+1);continue}else if(i==="-"&&o+1<t&&n[o+1]==="-"){o=s(o,o+2);continue}o++}return e}function an(n){return n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||n===95}function xe(n,e){let t=e;for(;t<n.length;){let o=n.charCodeAt(t);if(o!==32&&o!==9)break;t++}return t}function Rt(n,e,t,o=!0){let s=n.slice(e,e+t.length),r=o?t.toUpperCase():t;if((o?s.toUpperCase():s)!==r)return-1;let a=n.charCodeAt(e+t.length);if(an(a))return-1;let i=e+t.length;return(n[i]===":"||n[i]==="-")&&i++,i=xe(n,i),i}var Re=v(require("vscode")),Ce=class{provideCodeLenses(e,t){let o=e.getText(),s=[];for(let{index:r,body:a}of Pt(o)){if(t?.isCancellationRequested)break;let i=e.positionAt(r),c=new Re.Range(i,i);s.push(new Re.CodeLens(c,{title:"Implement with Codex",command:"chatgpt.implementTodo",arguments:[{fileName:encodeURIComponent(e.uri.fsPath),line:i.line+1,comment:a}]}))}return s}};P();var Pe=class{constructor(e){this.codexWebviewProvider=e}async handleUri(e){p.info({event:"handleUri",path:e.path});try{await D();let t=e.path||"/";this.codexWebviewProvider.navigateToRoute(t)}catch(t){p.error(`Failed to handle URI ${e.toString()}: ${t instanceof Error?t.message:String(t)}`)}}};var Se=class{userAgent=null;getUserAgent(){return this.userAgent}setUserAgent(e){this.userAgent=e}};var M=v(require("vscode"));async function yn(n){let{subscriptions:e}=n;e.push(p),p.info("Activating Codex extension");let t=new be;e.push(t);let o=new Se,s=await mt(n.extensionUri,o);e.push(s);let r=at(s),a=new ye(n),i=new we;e.push(i);let c=new ve(r,i,a),u=new ue(r,c,o),m=new $(n.extensionUri,s,u,i);e.push(m);let h=new Pe(m);if(e.push(M.window.registerUriHandler(h)),e.push(M.window.registerWebviewViewProvider($.viewType,m,{webviewOptions:{retainContextWhenHidden:!0}})),e.push(M.commands.registerCommand("chatgpt.openSidebar",D)),e.push(M.commands.registerCommand("chatgpt.addToChat",async()=>rt(m))),e.push(M.commands.registerCommand("chatgpt.newChat",async()=>{await D(),m.triggerNewChatViaWebview()})),k().get(G.COMMENT_CODELENS_ENABLED,!0)){let g=new Ce,S=[{scheme:"file"},{scheme:"untitled"}];e.push(M.languages.registerCodeLensProvider(S,g))}k().get(G.OPEN_ON_STARTUP,!1)&&D(),e.push(M.commands.registerCommand("chatgpt.dumpNuxState",()=>{a.dumpNuxState()}),M.commands.registerCommand("chatgpt.resetNuxState",()=>{a.resetNuxState()})),process.platform==="darwin"&&(async()=>{try{let g=await Promise.resolve().then(()=>(go(),ho));typeof g.activate=="function"&&(g.activate(n),p.info("Work with apps desktop bridge initialized"))}catch(g){p.warn("Desktop bridge init failed: "+(g instanceof Error?g.message:String(g)))}})()}0&&(module.exports={activate});
