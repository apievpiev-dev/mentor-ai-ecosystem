#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ–π –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π Multi-AI
# –ê–≤—Ç–æ—Ä: AI Assistant
# –î–∞—Ç–∞: $(date)

echo "ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–π –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π Multi-AI"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd /home/mentor

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source multi_agent_env/bin/activate

case "$1" in
    start)
        echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å—Ç–æ–π –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞
        if lsof -i:8080 > /dev/null 2>&1; then
            echo "‚ö†Ô∏è –°–∏—Å—Ç–µ–º–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8080"
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
            kill $(lsof -t -i:8080) 2>/dev/null
            sleep 5
        fi
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å—Ç—É—é —Å–∏—Å—Ç–µ–º—É
        nohup python3 simple_working_system.py > simple_system.log 2>&1 &
        
        # –ü–æ–ª—É—á–∞–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞
        SIMPLE_PID=$!
        echo "‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞ (PID: $SIMPLE_PID)"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º PID –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        echo $SIMPLE_PID > simple_system.pid
        
        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
        sleep 10
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã..."
        if curl -s http://localhost:8080/api/system/status | grep -q "running"; then
            echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞!"
            echo "üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://5.129.198.210:8080"
            echo "üìä API —Å—Ç–∞—Ç—É—Å–∞: http://5.129.198.210:8080/api/system/status"
            echo "üìã –õ–æ–≥–∏: tail -f /home/mentor/simple_system.log"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã"
            echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f /home/mentor/simple_system.log"
            exit 1
        fi
        
        echo "üéâ –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Multi-AI –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!"
        ;;
        
    stop)
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Å—Ç–æ–π –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã..."
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ PID —Ñ–∞–π–ª—É
        if [ -f simple_system.pid ]; then
            SIMPLE_PID=$(cat simple_system.pid)
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (PID: $SIMPLE_PID)..."
            kill $SIMPLE_PID 2>/dev/null
            rm -f simple_system.pid
        fi
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 8080
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 8080..."
        if lsof -i:8080 > /dev/null 2>&1; then
            kill $(lsof -t -i:8080) 2>/dev/null
            sleep 3
        fi
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ Python –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–æ—Å—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—Ä–æ—Å—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã..."
        pkill -f "simple_working_system.py" 2>/dev/null
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        sleep 5
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
        if lsof -i:8080 > /dev/null 2>&1; then
            echo "‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
            kill -9 $(lsof -t -i:8080) 2>/dev/null
        fi
        
        echo "‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
        ;;
        
    restart)
        echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ—Å—Ç–æ–π –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã..."
        $0 stop
        sleep 5
        $0 start
        ;;
        
    status)
        echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Å—Ç–æ–π –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:"
        
        if lsof -i:8080 > /dev/null 2>&1; then
            echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8080"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º API
            if curl -s http://localhost:8080/api/system/status > /dev/null 2>&1; then
                echo "‚úÖ API –æ—Ç–≤–µ—á–∞–µ—Ç"
                
                # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                echo "üìã –î–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å:"
                curl -s http://localhost:8080/api/system/status | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    print(f'  –°—Ç–∞—Ç—É—Å: {data[\"system_status\"]}')
    print(f'  –ê–≥–µ–Ω—Ç–æ–≤: {data[\"total_agents\"]}')
    print(f'  –ê–∫—Ç–∏–≤–Ω—ã—Ö: {data[\"active_agents\"]}')
    print(f'  –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: {data[\"uptime\"]}')
except:
    print('  –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞')
"
            else
                echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            fi
        else
            echo "‚ùå –°–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞"
        fi
        ;;
        
    logs)
        echo "üìã –õ–æ–≥–∏ –ø—Ä–æ—Å—Ç–æ–π –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:"
        if [ -f simple_system.log ]; then
            tail -50 simple_system.log
        else
            echo "‚ùå –§–∞–π–ª –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
        ;;
        
    *)
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {start|stop|restart|status|logs}"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  start   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Å—Ç—É—é –∞–≤—Ç–æ–Ω–æ–º–Ω—É—é —Å–∏—Å—Ç–µ–º—É"
        echo "  stop    - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Å—Ç—É—é –∞–≤—Ç–æ–Ω–æ–º–Ω—É—é —Å–∏—Å—Ç–µ–º—É"
        echo "  restart - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Å—Ç—É—é –∞–≤—Ç–æ–Ω–æ–º–Ω—É—é —Å–∏—Å—Ç–µ–º—É"
        echo "  status  - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã"
        echo "  logs    - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã"
        exit 1
        ;;
esac


